#! /bin/bash
PLUGINS_REPO=/etc/amonagent/plugins
REMOTE_REPO=https://github.com/amonapp/amon-plugins.git

set -e

case "$1" in
    configure)
        curl --insecure --silent --show-error --retry 5 -L https://bootstrap.pypa.io/ez_setup.py -o - | python
        curl --insecure --silent --show-error --retry 5 -L https://raw.githubusercontent.com/pypa/pip/master/contrib/get-pip.py | python
        pip install https://github.com/amonapp/amonagent/archive/master.zip
        update-rc.d amon-agent defaults
        sh -c "echo  '{\"server_key\": \"test\"}' > /etc/amon-agent.conf"
        adduser --system amonagent --disabled-login --shell /bin/sh --no-create-home --quiet
        groupadd amonagent -f
        usermod -a -G amonagent amonagent
        
        chown amonagent:amonagent /etc/init.d/amon-agent
        chown amonagent:amonagent /usr/bin/amonpm
        chown amonagent:amonagent /var/run/amonagent
        
        chown -R amonagent:amonagent /var/log/amonagent
        /etc/init.d/amon-agent restart
 
        LOCALREPO_VC_DIR=$PLUGINS_REPO/.git

        rm -rf $PLUGINS_REPO
        git clone $REMOTE_REPO $PLUGINS_REPO
        
        chown -R amonagent:amonagent /etc/amonagent
        set +e

    ;;
    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
    ;;
esac

#DEBHELPER#

exit 0
